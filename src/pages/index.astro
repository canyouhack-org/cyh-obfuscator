---
import Layout from "../layouts/Layout.astro";
import {
	SUPPORTED_LANGUAGES,
	LANGUAGE_CATEGORIES,
	presets,
} from "../lib/obfuscators/types";
---

<Layout>
	<div class="app">
		<!-- Header -->
		<header class="header">
			<div class="logo">
				<svg
					class="logo-chevron"
					width="24"
					height="24"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="3"
					stroke-linecap="round"
					stroke-linejoin="round"
				>
					<polyline points="9 18 15 12 9 6"></polyline>
				</svg>
				<span class="logo-underscore">_</span>
				<span class="logo-text"
					>CYH<span class="divider">|</span><span class="accent"
						>CanYouHack</span
					></span
				>
				<a
					href="https://github.com/canyouhack-org/cyh-obfuscator"
					target="_blank"
					class="github-badge"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						width="16"
						height="16"
						viewBox="0 0 24 24"
						fill="currentColor"
					>
						<path
							d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
						></path>
					</svg>
					<img
						src="https://img.sh	ields.io/github/stars/canyouhack-org/cyh-obfuscator?style=flat&color=9aff00&labelColor=0d0d0d"
						alt="GitHub Stars"
						class="stars-badge"
					/>
				</a>
			</div>
			<p class="tagline">
				Universal Code Obfuscator — {SUPPORTED_LANGUAGES.length} Languages
			</p>
		</header>

		<!-- Stats Bar -->

		<div class="stats-bar">
			<div class="stat">
				<span class="stat-value">{SUPPORTED_LANGUAGES.length}</span>
				<span class="stat-label">Languages</span>
			</div>
			<div class="stat">
				<span class="stat-value">10+</span>
				<span class="stat-label">Techniques</span>
			</div>
			<div class="stat">
				<span class="stat-value">3</span>
				<span class="stat-label">Presets</span>
			</div>
		</div>

		<!-- Main -->
		<main class="main">
			<!-- Config Bar -->
			<div class="config-bar">
				<div class="config-left">
					<div class="config-item">
						<span class="config-label">Language</span>
						<select id="language-select">
							{
								LANGUAGE_CATEGORIES.map((cat) => (
									<optgroup label={cat.name}>
										{SUPPORTED_LANGUAGES.filter(
											(l) => l.category === cat.id,
										).map((lang) => (
											<option value={lang.id}>
												{lang.name}
											</option>
										))}
									</optgroup>
								))
							}
						</select>
					</div>
					<div class="config-item">
						<span class="config-label">Preset</span>
						<select id="preset-select">
							<option value="custom">Custom</option>
							<option value="quick">Quick</option>
							<option value="strong" selected>Strong</option>
							<option value="maximum">Maximum</option>
						</select>
					</div>
					<div class="config-item">
						<span class="config-label">Intensity</span>
						<select id="intensity-select">
							<option value="low">Low</option>
							<option value="medium">Medium</option>
							<option value="high" selected>High</option>
							<option value="extreme">Extreme</option>
						</select>
					</div>
				</div>
				<div class="config-right">
					<button id="obfuscate-btn" class="btn btn-primary">
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="14"
							height="14"
							viewBox="0 0 24 24"
							fill="none"
							stroke="currentColor"
							stroke-width="2.5"
							><path
								d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"
							></path></svg
						>
						Obfuscate
					</button>
				</div>
			</div>

			<!-- Options -->
			<div class="options-section">
				<button class="options-toggle" id="options-toggle">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						width="14"
						height="14"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
						><path
							d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"
						></path><circle cx="12" cy="12" r="3"></circle></svg
					>
					Options
					<svg
						class="chevron"
						xmlns="http://www.w3.org/2000/svg"
						width="12"
						height="12"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"><path d="m6 9 6 6 6-6"></path></svg
					>
				</button>
				<div class="options-grid" id="options-grid">
					<label class="checkbox-item">
						<input
							type="checkbox"
							id="opt-renameVariables"
							checked
						/>
						<span class="checkbox-box"></span>
						<span class="checkbox-label">Rename Variables</span>
					</label>
					<label class="checkbox-item">
						<input type="checkbox" id="opt-encodeStrings" checked />
						<span class="checkbox-box"></span>
						<span class="checkbox-label">Encode Strings</span>
					</label>
					<label class="checkbox-item">
						<input
							type="checkbox"
							id="opt-removeComments"
							checked
						/>
						<span class="checkbox-box"></span>
						<span class="checkbox-label">Remove Comments</span>
					</label>
					<label class="checkbox-item">
						<input
							type="checkbox"
							id="opt-controlFlowFlattening"
							checked
						/>
						<span class="checkbox-box"></span>
						<span class="checkbox-label">Control Flow</span>
					</label>
					<label class="checkbox-item">
						<input
							type="checkbox"
							id="opt-deadCodeInjection"
							checked
						/>
						<span class="checkbox-box"></span>
						<span class="checkbox-label">Dead Code</span>
					</label>
					<label class="checkbox-item">
						<input type="checkbox" id="opt-unicodeEscape" checked />
						<span class="checkbox-box"></span>
						<span class="checkbox-label">Unicode Escape</span>
					</label>
					<label class="checkbox-item">
						<input type="checkbox" id="opt-hexEncoding" checked />
						<span class="checkbox-box"></span>
						<span class="checkbox-label">Hex Encoding</span>
					</label>
					<label class="checkbox-item">
						<input type="checkbox" id="opt-base64Strings" />
						<span class="checkbox-box"></span>
						<span class="checkbox-label">Base64 Strings</span>
					</label>
					<label class="checkbox-item">
						<input type="checkbox" id="opt-shuffleCode" checked />
						<span class="checkbox-box"></span>
						<span class="checkbox-label">Shuffle Code</span>
					</label>
					<label class="checkbox-item">
						<input type="checkbox" id="opt-minify" />
						<span class="checkbox-box"></span>
						<span class="checkbox-label">Minify</span>
					</label>
				</div>
			</div>

			<!-- Editors -->
			<div class="editors">
				<div class="editor-panel">
					<div class="editor-header">
						<span class="editor-title">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="14"
								height="14"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
								><path
									d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"
								></path></svg
							>
							Input
						</span>
						<div class="editor-actions">
							<button class="btn" id="upload-btn" title="Upload">
								<svg
									xmlns="http://www.w3.org/2000/svg"
									width="14"
									height="14"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									><path
										d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
									></path><polyline points="17 8 12 3 7 8"
									></polyline><line
										x1="12"
										x2="12"
										y1="3"
										y2="15"></line></svg
								>
							</button>
							<button class="btn" id="clear-btn" title="Clear">
								<svg
									xmlns="http://www.w3.org/2000/svg"
									width="14"
									height="14"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									><path d="M3 6h18"></path><path
										d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"
									></path><path
										d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"
									></path></svg
								>
							</button>
							<input type="file" id="file-input" hidden />
						</div>
					</div>
					<textarea
						id="input-code"
						class="editor-area"
						placeholder="// Paste your code here..."
						spellcheck="false"></textarea>
					<div class="editor-footer">
						<span id="input-stats">0 chars • 0 lines</span>
						<span id="input-lang" class="lang-badge"></span>
					</div>
				</div>

				<div class="editor-panel">
					<div class="editor-header">
						<span class="editor-title">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="14"
								height="14"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
								><rect
									width="18"
									height="11"
									x="3"
									y="11"
									rx="2"
									ry="2"></rect><path
									d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg
							>
							Output
						</span>
						<div class="editor-actions">
							<button class="btn" id="copy-btn" title="Copy">
								<svg
									xmlns="http://www.w3.org/2000/svg"
									width="14"
									height="14"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									><rect
										width="14"
										height="14"
										x="8"
										y="8"
										rx="2"
										ry="2"></rect><path
										d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"
									></path></svg
								>
							</button>
							<button
								class="btn"
								id="download-btn"
								title="Download"
							>
								<svg
									xmlns="http://www.w3.org/2000/svg"
									width="14"
									height="14"
									viewBox="0 0 24 24"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									><path
										d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
									></path><polyline points="7 10 12 15 17 10"
									></polyline><line
										x1="12"
										x2="12"
										y1="15"
										y2="3"></line></svg
								>
							</button>
						</div>
					</div>
					<textarea
						id="output-code"
						class="editor-area"
						placeholder="// Obfuscated code..."
						readonly
						spellcheck="false"></textarea>
					<div class="editor-footer">
						<span id="output-stats">0 chars • 0 lines</span>
						<span id="size-diff" class="size-diff"></span>
					</div>
				</div>
			</div>
		</main>

		<!-- Toast -->
		<div id="toast" class="toast"></div>

		<!-- Footer -->
		<footer class="footer">
			<div class="footer-main">
				<span>CanYouHack</span>
				<span class="separator">•</span>
				<span class="muted">Protect your code</span>
			</div>
			<div class="ctf-banner">
				<svg
					xmlns="http://www.w3.org/2000/svg"
					width="14"
					height="14"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
				>
					<path
						d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"
					></path>
					<line x1="4" x2="4" y1="22" y2="15"></line>
				</svg>
				<span
					>New to cybersecurity? Start practicing with CTF challenges
					on
				</span>
				<a href="https://canyouhack.org" target="_blank" rel="noopener"
					>canyouhack.org</a
				>
			</div>
		</footer>
	</div>

	<style>
		.app {
			min-height: 100vh;
			padding: var(--space-lg);
			max-width: 1400px;
			margin: 0 auto;
			display: flex;
			flex-direction: column;
		}

		/* Header */
		.header {
			text-align: center;
			margin-bottom: var(--space-lg);
		}

		.logo {
			display: inline-flex;
			align-items: center;
			gap: 4px;
			font-family: var(--font-mono);
			font-size: 1.4rem;
			font-weight: 700;
		}

		.logo-chevron {
			color: #fff;
		}
		.logo-underscore {
			color: var(--accent);
			margin-left: -4px;
		}
		.logo-text {
			margin-left: 8px;
		}
		.logo-text .divider {
			color: var(--text-muted);
			margin: 0 6px;
		}
		.logo-text .accent {
			color: var(--accent);
		}

		.tagline {
			color: var(--text-muted);
			font-size: 0.85rem;
			margin-top: var(--space-xs);
			font-family: var(--font-mono);
		}

		/* Stats Bar */
		.stats-bar {
			display: flex;
			justify-content: center;
			gap: var(--space-xl);
			padding: var(--space-md) 0;
			margin-bottom: var(--space-lg);
			border-bottom: 1px solid var(--border-color);
		}

		.stat {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 2px;
		}

		.stat-value {
			font-family: var(--font-mono);
			font-size: 1.5rem;
			font-weight: 700;
			color: var(--accent);
		}

		.stat-label {
			font-size: 0.7rem;
			color: var(--text-muted);
			text-transform: uppercase;
			letter-spacing: 0.1em;
		}

		/* Config Bar */
		.config-bar {
			display: flex;
			justify-content: space-between;
			align-items: flex-end;
			margin-bottom: var(--space-md);
			flex-wrap: wrap;
			gap: var(--space-md);
		}

		.config-left {
			display: flex;
			gap: var(--space-md);
			flex-wrap: wrap;
		}

		.config-item {
			display: flex;
			flex-direction: column;
			gap: var(--space-xs);
		}

		.config-label {
			font-size: 0.65rem;
			text-transform: uppercase;
			letter-spacing: 0.1em;
			color: var(--text-muted);
		}

		.config-item select {
			min-width: 120px;
		}

		/* Options */
		.options-section {
			margin-bottom: var(--space-md);
		}

		.options-toggle {
			display: flex;
			align-items: center;
			gap: var(--space-sm);
			background: none;
			border: none;
			color: var(--text-secondary);
			font-family: var(--font-mono);
			font-size: 0.8rem;
			cursor: pointer;
			padding: var(--space-sm) 0;
			transition: color 0.15s;
		}

		.options-toggle:hover {
			color: var(--text-primary);
		}
		.options-toggle .chevron {
			transition: transform 0.2s;
		}
		.options-toggle.collapsed .chevron {
			transform: rotate(-90deg);
		}

		.options-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
			gap: var(--space-xs) var(--space-md);
			padding: var(--space-sm) 0;
			border-top: 1px solid var(--border-color);
		}

		.options-grid.hidden {
			display: none;
		}

		/* Editors */
		.editors {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: var(--space-md);
			flex: 1;
		}

		@media (max-width: 900px) {
			.editors {
				grid-template-columns: 1fr;
			}
			.stats-bar {
				gap: var(--space-lg);
			}
		}

		.editor-panel {
			display: flex;
			flex-direction: column;
		}

		.editor-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding-bottom: var(--space-xs);
		}

		.editor-title {
			display: flex;
			align-items: center;
			gap: var(--space-sm);
			font-family: var(--font-mono);
			font-size: 0.75rem;
			color: var(--text-secondary);
		}

		.editor-title svg {
			color: var(--accent);
		}
		.editor-actions {
			display: flex;
			gap: 4px;
		}
		.editor-actions .btn {
			padding: 4px 8px;
		}
		.editor-panel .editor-area {
			flex: 1;
			min-height: 320px;
			font-size: 0.8rem;
		}

		.editor-footer {
			padding-top: var(--space-xs);
			font-family: var(--font-mono);
			font-size: 0.65rem;
			color: var(--text-muted);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.lang-badge {
			color: var(--accent);
			font-weight: 500;
		}

		.size-diff {
			padding: 2px 6px;
			border-radius: 4px;
			font-size: 0.6rem;
			font-weight: 600;
		}

		.size-diff.increase {
			background: rgba(154, 255, 0, 0.15);
			color: var(--accent);
		}

		/* Toast */
		.toast {
			position: fixed;
			bottom: var(--space-lg);
			left: 50%;
			transform: translateX(-50%) translateY(100px);
			background: var(--bg-card);
			border: 1px solid var(--accent);
			color: var(--accent);
			padding: var(--space-sm) var(--space-lg);
			border-radius: var(--radius-md);
			font-family: var(--font-mono);
			font-size: 0.8rem;
			opacity: 0;
			transition: all 0.3s ease;
			pointer-events: none;
		}

		.toast.show {
			opacity: 1;
			transform: translateX(-50%) translateY(0);
		}

		/* Footer */
		.footer {
			text-align: center;
			padding-top: var(--space-lg);
			font-family: var(--font-mono);
			font-size: 0.7rem;
			color: var(--text-secondary);
		}

		.footer-main {
			margin-bottom: var(--space-sm);
		}

		.footer .separator {
			color: var(--text-muted);
			margin: 0 var(--space-sm);
		}
		.footer .muted {
			color: var(--text-muted);
		}

		.ctf-banner {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: var(--space-xs);
			padding: var(--space-sm) var(--space-md);
			background: rgba(154, 255, 0, 0.05);
			border: 1px solid rgba(154, 255, 0, 0.2);
			border-radius: var(--radius-md);
			margin-top: var(--space-md);
			color: var(--text-muted);
		}

		.ctf-banner svg {
			color: var(--accent);
			flex-shrink: 0;
		}

		.ctf-banner a {
			color: var(--accent);
			text-decoration: none;
			font-weight: 600;
		}

		.ctf-banner a:hover {
			text-decoration: underline;
		}

		/* GitHub Badge */
		.github-badge {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			margin-left: var(--space-md);
			padding: 4px 10px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--border-color);
			border-radius: var(--radius-md);
			color: var(--text-secondary);
			text-decoration: none;
			transition: all 0.2s;
		}

		.github-badge:hover {
			background: rgba(154, 255, 0, 0.1);
			border-color: var(--accent);
			color: var(--accent);
		}

		.github-badge svg {
			flex-shrink: 0;
		}

		.stars-badge {
			height: 18px;
			vertical-align: middle;
		}
	</style>

	<script>
		import {
			obfuscateCode,
			SUPPORTED_LANGUAGES,
			presets,
		} from "../lib/obfuscators";
		import type {
			ObfuscationOptions,
			SupportedLanguage,
		} from "../lib/obfuscators/types";

		const $ = (s: string) => document.getElementById(s);

		const languageSelect = $("language-select") as HTMLSelectElement;
		const presetSelect = $("preset-select") as HTMLSelectElement;
		const intensitySelect = $("intensity-select") as HTMLSelectElement;
		const inputCode = $("input-code") as HTMLTextAreaElement;
		const outputCode = $("output-code") as HTMLTextAreaElement;
		const obfuscateBtn = $("obfuscate-btn") as HTMLButtonElement;
		const clearBtn = $("clear-btn") as HTMLButtonElement;
		const copyBtn = $("copy-btn") as HTMLButtonElement;
		const downloadBtn = $("download-btn") as HTMLButtonElement;
		const uploadBtn = $("upload-btn") as HTMLButtonElement;
		const fileInput = $("file-input") as HTMLInputElement;
		const optionsToggle = $("options-toggle") as HTMLButtonElement;
		const optionsGrid = $("options-grid") as HTMLDivElement;
		const inputStats = $("input-stats") as HTMLSpanElement;
		const outputStats = $("output-stats") as HTMLSpanElement;
		const inputLang = $("input-lang") as HTMLSpanElement;
		const sizeDiff = $("size-diff") as HTMLSpanElement;
		const toast = $("toast") as HTMLDivElement;

		const optionIds = [
			"renameVariables",
			"encodeStrings",
			"removeComments",
			"controlFlowFlattening",
			"deadCodeInjection",
			"unicodeEscape",
			"hexEncoding",
			"base64Strings",
			"shuffleCode",
			"minify",
		];

		function getOptions(): ObfuscationOptions {
			const opts: Record<string, boolean | string> = {};
			optionIds.forEach((id) => {
				opts[id] = ($(`opt-${id}`) as HTMLInputElement).checked;
			});
			opts.intensity = intensitySelect.value;
			return opts as unknown as ObfuscationOptions;
		}

		function setOptions(preset: ObfuscationOptions) {
			optionIds.forEach((id) => {
				const el = $(`opt-${id}`) as HTMLInputElement;
				if (el && id in preset) {
					el.checked = (
						preset as unknown as Record<string, boolean | string>
					)[id] as boolean;
				}
			});
			intensitySelect.value = preset.intensity;
		}

		function updateStats(el: HTMLTextAreaElement, stat: HTMLSpanElement) {
			const chars = el.value.length;
			const lines = el.value ? el.value.split("\n").length : 0;
			stat.textContent = `${chars.toLocaleString()} chars • ${lines} lines`;
		}

		function updateLangBadge() {
			const lang = SUPPORTED_LANGUAGES.find(
				(l) => l.id === languageSelect.value,
			);
			inputLang.textContent = lang?.name || "";
		}

		function updateSizeDiff() {
			const inputLen = inputCode.value.length;
			const outputLen = outputCode.value.length;
			if (inputLen > 0 && outputLen > 0) {
				const diff = (
					((outputLen - inputLen) / inputLen) *
					100
				).toFixed(0);
				sizeDiff.textContent = `+${diff}%`;
				sizeDiff.className = "size-diff increase";
			} else {
				sizeDiff.textContent = "";
				sizeDiff.className = "size-diff";
			}
		}

		function showToast(msg: string) {
			toast.textContent = msg;
			toast.classList.add("show");
			setTimeout(() => toast.classList.remove("show"), 2500);
		}

		// Events
		inputCode.addEventListener("input", () =>
			updateStats(inputCode, inputStats),
		);
		languageSelect.addEventListener("change", updateLangBadge);

		presetSelect.addEventListener("change", () => {
			const val = presetSelect.value;
			if (val === "quick") setOptions(presets.quick);
			else if (val === "strong") setOptions(presets.strong);
			else if (val === "maximum") setOptions(presets.maximum);
		});

		// When any option changes, set preset to custom
		optionIds.forEach((id) => {
			const el = $(`opt-${id}`) as HTMLInputElement;
			if (el)
				el.addEventListener(
					"change",
					() => (presetSelect.value = "custom"),
				);
		});
		intensitySelect.addEventListener(
			"change",
			() => (presetSelect.value = "custom"),
		);

		optionsToggle.addEventListener("click", () => {
			optionsToggle.classList.toggle("collapsed");
			optionsGrid.classList.toggle("hidden");
		});

		obfuscateBtn.addEventListener("click", () => {
			const code = inputCode.value.trim();
			if (!code) return showToast("Enter code first");

			try {
				const result = obfuscateCode(
					code,
					languageSelect.value as SupportedLanguage,
					getOptions(),
				);
				outputCode.value = result;
				updateStats(outputCode, outputStats);
				updateSizeDiff();
				showToast("Obfuscated!");
			} catch (e) {
				showToast("Error");
				console.error(e);
			}
		});

		clearBtn.addEventListener("click", () => {
			inputCode.value = "";
			outputCode.value = "";
			updateStats(inputCode, inputStats);
			updateStats(outputCode, outputStats);
			sizeDiff.textContent = "";
			sizeDiff.className = "size-diff";
		});

		copyBtn.addEventListener("click", async () => {
			if (!outputCode.value) return showToast("Nothing to copy");
			await navigator.clipboard.writeText(outputCode.value);
			showToast("Copied!");
		});

		downloadBtn.addEventListener("click", () => {
			if (!outputCode.value) return showToast("Nothing to download");
			const lang = SUPPORTED_LANGUAGES.find(
				(l) => l.id === languageSelect.value,
			);
			const ext = lang?.extension || ".txt";
			const blob = new Blob([outputCode.value], { type: "text/plain" });
			const a = document.createElement("a");
			a.href = URL.createObjectURL(blob);
			a.download = `obfuscated${ext}`;
			a.click();
			URL.revokeObjectURL(a.href);
			showToast(`Downloaded obfuscated${ext}`);
		});

		uploadBtn.addEventListener("click", () => fileInput.click());

		fileInput.addEventListener("change", async (e) => {
			const file = (e.target as HTMLInputElement).files?.[0];
			if (!file) return;
			inputCode.value = await file.text();
			updateStats(inputCode, inputStats);

			const ext = "." + file.name.split(".").pop()?.toLowerCase();
			const lang = SUPPORTED_LANGUAGES.find((l) => l.extension === ext);
			if (lang) {
				languageSelect.value = lang.id;
				updateLangBadge();
			}
			showToast(`Loaded ${file.name}`);
		});

		// Initialize
		updateLangBadge();
		setOptions(presets.strong);
	</script>
</Layout>
